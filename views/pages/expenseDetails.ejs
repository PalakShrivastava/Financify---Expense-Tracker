<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title || "Financify" %></title>

  <!-- CSS link-->
  <link rel="stylesheet" href="/css/style.css">
  <!-- Bootstrap link -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome CDN link-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

</head>
<body style="background-color: #e6f4ea;">
  <%- include("../includes/navbar.ejs") %>
<div class="container mt-4">
  <div class="card shadow p-4" style="border-radius: 15px; background: #fff; max-width: 1000px; margin: auto;">
    <div class="row g-4">
      
      <!-- Left Side: Expense List -->
      <div class="col-md-6">
        <h3 class="mb-3"><strong>Date:</strong> <%= group.date.toDateString() %></h3>
        <ul class="list-group">
          <% group.expenses.forEach(exp => { %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><%= exp.item %> (<%= exp.category %>)</span>
              <span>₹<%= exp.amount %></span>
            </li>
          <% }) %>
        </ul>
      </div>

      <!-- Right Side: Pie Chart -->
      <div class="col-md-6 d-flex flex-column align-items-center">
        <h4 class="mb-3 text-center">Category Wise Spending </h4>
        <canvas id="expenseChart" style="max-width: 100%; height: 300px;"></canvas>
      </div>

    </div>
  </div>
</div>


<!-- Chart.js + DataLabels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script>
  const expenses = <%- JSON.stringify(group.expenses) %>;

  const categories = ["Food", "Travel", "Shopping", "Bills", "Other"];
  const categoryTotals = {};
  categories.forEach(cat => categoryTotals[cat] = 0);

  expenses.forEach(exp => {
    categoryTotals[exp.category] += exp.amount;
  });

  const data = {
    labels: categories,
    datasets: [{
      label: 'Expense Distribution',
      data: categories.map(cat => categoryTotals[cat]),
      backgroundColor: ['#4caf50', '#ff9800', '#2196f3', '#f44336', '#9c27b0'],
      borderWidth: 1
    }]
  };

  const config = {
    type: 'pie',
    data: data,
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        datalabels: {
          color: '#fff',
          font: { weight: 'bold', size: 14 },
          formatter: (value, ctx) => {
            const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            const percentage = (value / total) * 100;

            // ✅ Sirf tabhi dikhana jab >= 3%
            return percentage >= 3 ? percentage.toFixed(1) + "%" : "";
          }
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              const value = context.raw;
              const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1) + '%';
              return `${context.label}: ₹${value} (${percentage})`;
            }
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  };

  const ctx = document.getElementById('expenseChart').getContext('2d');
  new Chart(ctx, config);
</script>


</body>
</html>
